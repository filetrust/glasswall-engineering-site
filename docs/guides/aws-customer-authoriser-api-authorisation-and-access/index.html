<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165717322-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-165717322-1",{})</script><title data-react-helmet="true">AWS Custom Authorizer - API Authorization and Access Proposal – 2 Step solution (recommended) | Glasswall Engineering</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="AWS Custom Authorizer - API Authorization and Access Proposal – 2 Step solution (recommended) | Glasswall Engineering"><meta data-react-helmet="true" name="description" content="Background and Problem"><meta data-react-helmet="true" property="og:description" content="Background and Problem"><meta data-react-helmet="true" property="og:url" content="https://filetrust.github.io/docs/guides/aws-customer-authoriser-api-authorisation-and-access"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://filetrust.github.io/docs/guides/aws-customer-authoriser-api-authorisation-and-access"><link rel="stylesheet" href="/styles.f6f65d30.css">
<link rel="preload" href="/styles.0b8a685c.js" as="script">
<link rel="preload" href="/runtime~main.4a221970.js" as="script">
<link rel="preload" href="/main.92f7f6f7.js" as="script">
<link rel="preload" href="/1.3c8e1916.js" as="script">
<link rel="preload" href="/2.aa76eeee.js" as="script">
<link rel="preload" href="/3.8eec507e.js" as="script">
<link rel="preload" href="/1be78505.39cc9c7c.js" as="script">
<link rel="preload" href="/67.90a1f7be.js" as="script">
<link rel="preload" href="/20ac7829.430ab2c0.js" as="script">
<link rel="preload" href="/17896441.1ba19637.js" as="script">
<link rel="preload" href="/21d9944d.fa479403.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/glasswall_logo_blue.png" alt="Glasswall Logo"><strong class="navbar__title">Glasswall Engineering</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/product-descriptions/product-overview">Documentation</a><a href="https://medium.com/glasswall-engineering" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/glasswall_logo_blue.png" alt="Glasswall Logo"><strong class="navbar__title">Glasswall Engineering</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/product-descriptions/product-overview">Documentation</a></li><li class="menu__list-item"><a href="https://medium.com/glasswall-engineering" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li><li class="menu__list-item"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">AWS Custom Authorizer - API Authorization and Access Proposal – 2 Step solution (recommended)</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="background-and-problem"></a>Background and Problem<a aria-hidden="true" tabindex="-1" class="hash-link" href="#background-and-problem" title="Direct link to heading">#</a></h1><p>Currently, we are using AWS API Gateway usage plans for gaining access to a hosted amazon resource we offer. This approach has negative implications which is why I have produced this solution which is the more secure and recommended way of authenticating a user to gain access to an API.</p><p>Some of the main disadvantages to the current way which we are authenticating users to access our APIs and invoke our products are:</p><ul><li>It is not the recommended approach by AWS. &quot;Don&#x27;t rely on API keys as your only means of authentication and authorization for your APIs&quot; (AWS).</li><li>If a single user gets access to a valid API key which is used across multiple APIs then the user can have access to multiple APIs.</li><li>We are currently relying on usage plans which allows for a throttle and quota to be set, but this is not a viable and long-lasting solution as the quota will auto renew. The problem here is if a user purchases 50 credits and gets an API key, then they will have 50 credits for life and not one off!</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="solution-overview"></a>Solution Overview<a aria-hidden="true" tabindex="-1" class="hash-link" href="#solution-overview" title="Direct link to heading">#</a></h1><p>This document will provide a solution which can be used across all products for customers accessing our products which are hosted on AWS in a safe and secure way.</p><p>After carrying out extensive research, I have learnt about a very common and effective approach that will enable us to be able to maintain user access in a centralised location (DB) and will eliminate the blockers we face with usage plans, the main being the lack of capability to have a one of API key. As the quota works on a monthly basis.</p><p>The AWS services this solution will make use of are as follows:</p><ul><li>S3</li><li>Lambda</li><li>API Gateway <ul><li>Lambda Authorizer</li></ul></li><li>SES</li><li>DynamoDB (can be Amazon ElastiCache or DynamoDB, Google Cloud Datastore, etc.)</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="useful-resources"></a>Useful resources<a aria-hidden="true" tabindex="-1" class="hash-link" href="#useful-resources" title="Direct link to heading">#</a></h2><p>Here are some of the resources which I extracted and found very useful from my research:</p><ul><li><a href="https://www.youtube.com/watch?v=-0EG17oVxV0&amp;feature=youtu.be">https://www.youtube.com/watch?v=-0EG17oVxV0&amp;feature=youtu.be</a> – A brief video from AWS showing a way of authorizing with JWT. Similar to my suggestion below, but my suggestion is custom to our needs.</li><li><a href="https://serverless.com/blog/strategies-implementing-user-authentication-serverless-applications/" target="_blank" rel="noopener noreferrer">https://serverless.com/blog/strategies-implementing-user-authentication-serverless-applications/</a> - Very good article from an architect at serverless which talks about the pros and cons of DB and JSON Web Tokens.</li><li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html">https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html</a> - This is on the AWS documentation which talks about usage plans and states how it is not recommended as an only means of authorisation</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-flows"></a>User Flows<a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-flows" title="Direct link to heading">#</a></h1><p>Below are 3 flows which present how this new form of authorisation works:</p><p><img src="https://github.com/filetrust/glasswall-engineering-site/blob/master/docs/guides/img/custom-authorizer-flow1-purchase-from-store.png" alt="custom-authorizer-flow1"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-purchases-a-product-from-store"></a>User Purchases a product from store:<a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-purchases-a-product-from-store" title="Direct link to heading">#</a></h2><ol><li>User purchases a product from Shopify.</li><li>An event gets triggered from Zapier which gets the username/email/product/quantity(credits) invokes an API with these details.</li><li>The Lambda adds or updates an entry with the information retrieved from the users purchase. The table will include details such as user access credentials (identifiers that we generate), products (each product listed), products credits (credits for each product to keep track of how many the user purchased).</li><li>Amazon SES is invoked with access credentials which the user will need to generate a temporary JWT.</li><li>User receives an email.</li></ol><p><img src="https://github.com/filetrust/glasswall-engineering-site/blob/master/docs/guides/img/custom-authorizer-flow2-generate-token-from-access-credentials.png" alt="custom-authorizer-flow2"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-generates-jwt-using-the-access-credentials-emails-to-them"></a>User generates JWT using the access credentials emails to them<a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-generates-jwt-using-the-access-credentials-emails-to-them" title="Direct link to heading">#</a></h2><ol><li>The user invokes the API the generate the JWT providing the access credentials as query string parameters.</li><li>The Lambda query&#x27;s the database to get the user information based on the credentials provided.</li><li>The Lambda creates the JWT.</li><li>The JWT is returned to the user as a JSON response.</li></ol><p><img src="https://github.com/filetrust/glasswall-engineering-site/blob/master/docs/guides/img/custom-authorizer-flow3-lambda-authoriser.png" alt="custom-authorizer-flow3"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-invokes-the-product-api-endpoint"></a>User invokes the product API endpoint<a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-invokes-the-product-api-endpoint" title="Direct link to heading">#</a></h2><ol><li>The user invokes the product API endpoint sending through the JWT as a header (the same way x-api-key is provided).</li><li>The Lambda will then validate the token:</li><li>Decode JWT</li><li>Query DB to see if the user has permission and credits to access the API endpoint.</li><li>If the token is valid, a policy is created which is set to execute::allow, otherwise execute::deny.</li><li>Then, the flow will either continue to execute the product Lambda, or deny the user access and not execute the product Lambda.</li></ol><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="advantages-of-this-approach"></a>Advantages of this approach:<a aria-hidden="true" tabindex="-1" class="hash-link" href="#advantages-of-this-approach" title="Direct link to heading">#</a></h1><ul><li>Centralized authentication solution to be used across all application<ul><li>If our authentication approach changes, it will require a change only in a single location</li><li>We can make use of JWT tokens with a short expiry time to ensure better security</li><li>We will maintain a database with all data relevant to us (e.g. credits available)<ul><li>This also accommodates for scenarios where the user invoked an API in error or one of our APIs returning an error (caused by code). We will be able to quickly modify the available credits for the customer</li></ul></li></ul></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#useful-resources" class="table-of-contents__link">Useful resources</a></li><li><a href="#user-purchases-a-product-from-store" class="table-of-contents__link">User Purchases a product from store:</a></li><li><a href="#user-generates-jwt-using-the-access-credentials-emails-to-them" class="table-of-contents__link">User generates JWT using the access credentials emails to them</a></li><li><a href="#user-invokes-the-product-api-endpoint" class="table-of-contents__link">User invokes the product API endpoint</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/products/cloud-sdk/rebuild/rebuild-quickstart">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/glasswall" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/glasswallglobal" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/glasswall-solutions-limited/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Glasswall Solutions Ltd. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.0b8a685c.js"></script>
<script src="/runtime~main.4a221970.js"></script>
<script src="/main.92f7f6f7.js"></script>
<script src="/1.3c8e1916.js"></script>
<script src="/2.aa76eeee.js"></script>
<script src="/3.8eec507e.js"></script>
<script src="/1be78505.39cc9c7c.js"></script>
<script src="/67.90a1f7be.js"></script>
<script src="/20ac7829.430ab2c0.js"></script>
<script src="/17896441.1ba19637.js"></script>
<script src="/21d9944d.fa479403.js"></script>
</body>
</html>